# S3

**対象：オブジェクトストレージ**

---

# 【現行調査】

## コンポーネント側

## Amazon S3 管理イベント（コントロールプレーン） | デフォルトで取得

| アクション                                 | 説明                                                               |
| ------------------------------------------ | ------------------------------------------------------------------ |
| AssociateAccessGrantsIdentityCenter        | Access GrantsをIAM Identity Centerと関連付ける                     |
| CreateAccessGrant                          | アクセス許可を作成する                                             |
| CreateAccessGrantsInstance                 | Access Grantsインスタンスを作成する                                |
| CreateAccessGrantsLocation                 | Access Grantsロケーションを作成する                                |
| CreateAccessPoint                          | アクセスポイントを作成する                                         |
| CreateAccessPointForObjectLambda           | Object Lambda用アクセスポイントを作成する                          |
| CreateBucket                               | Outposts用バケットを作成する                                       |
| CreateJob                                  | S3バッチオペレーションジョブを作成する                             |
| CreateMultiRegionAccessPoint               | マルチリージョンアクセスポイントを作成する                         |
| CreateStorageLensGroup                     | Storage Lensグループを作成する                                     |
| DeleteAccessGrant                          | アクセス許可を削除する                                             |
| DeleteAccessGrantsInstance                 | Access Grantsインスタンスを削除する                                |
| DeleteAccessGrantsInstanceResourcePolicy   | Access Grantsインスタンスのリソースポリシーを削除する              |
| DeleteAccessGrantsLocation                 | Access Grantsロケーションを削除する                                |
| DeleteAccessPoint                          | アクセスポイントを削除する                                         |
| DeleteAccessPointForObjectLambda           | Object Lambda用アクセスポイントを削除する                          |
| DeleteAccessPointPolicy                    | アクセスポイントポリシーを削除する                                 |
| DeleteAccessPointPolicyForObjectLambda     | Object Lambda用アクセスポイントポリシーを削除する                  |
| DeleteAccessPointScope                     | アクセスポイントスコープを削除する                                 |
| DeleteBucket                               | Outposts用バケットを削除する                                       |
| DeleteBucketLifecycleConfiguration         | Outposts用バケットのライフサイクル設定を削除する                   |
| DeleteBucketPolicy                         | Outposts用バケットポリシーを削除する                               |
| DeleteBucketReplication                    | Outposts用バケットのレプリケーション設定を削除する                 |
| DeleteBucketTagging                        | Outposts用バケットタグを削除する                                   |
| DeleteJobTagging                           | バッチオペレーションジョブのタグを削除する                         |
| DeleteMultiRegionAccessPoint               | マルチリージョンアクセスポイントを削除する                         |
| DeletePublicAccessBlock                    | アカウントレベルのパブリックアクセスブロック設定を削除する         |
| DeleteStorageLensConfiguration             | Storage Lens設定を削除する                                         |
| DeleteStorageLensConfigurationTagging      | Storage Lens設定のタグを削除する                                   |
| DeleteStorageLensGroup                     | Storage Lensグループを削除する                                     |
| DescribeJob                                | バッチオペレーションジョブの詳細を取得する                         |
| DescribeMultiRegionAccessPointOperation    | マルチリージョンアクセスポイント操作の状態を取得する               |
| DissociateAccessGrantsIdentityCenter       | Access GrantsとIAM Identity Centerの関連付けを解除する             |
| GetAccessGrant                             | アクセス許可の詳細を取得する                                       |
| GetAccessGrantsInstance                    | Access Grantsインスタンスの詳細を取得する                          |
| GetAccessGrantsInstanceForPrefix           | プレフィックスに対応するAccess Grantsインスタンスを取得する        |
| GetAccessGrantsInstanceResourcePolicy      | Access Grantsインスタンスのリソースポリシーを取得する              |
| GetAccessGrantsLocation                    | Access Grantsロケーションの詳細を取得する                          |
| GetAccessPoint                             | アクセスポイントの詳細を取得する                                   |
| GetAccessPointConfigurationForObjectLambda | Object Lambda用アクセスポイント設定を取得する                      |
| GetAccessPointForObjectLambda              | Object Lambda用アクセスポイントの詳細を取得する                    |
| GetAccessPointPolicy                       | アクセスポイントポリシーを取得する                                 |
| GetAccessPointPolicyForObjectLambda        | Object Lambda用アクセスポイントポリシーを取得する                  |
| GetAccessPointPolicyStatus                 | アクセスポイントポリシーのパブリック状態を取得する                 |
| GetAccessPointPolicyStatusForObjectLambda  | Object Lambda用アクセスポイントポリシーのパブリック状態を取得する  |
| GetAccessPointScope                        | アクセスポイントスコープを取得する                                 |
| GetBucket                                  | Outposts用バケットの詳細を取得する                                 |
| GetBucketLifecycleConfiguration            | Outposts用バケットのライフサイクル設定を取得する                   |
| GetBucketPolicy                            | Outposts用バケットポリシーを取得する                               |
| GetBucketReplication                       | Outposts用バケットのレプリケーション設定を取得する                 |
| GetBucketTagging                           | Outposts用バケットタグを取得する                                   |
| GetBucketVersioning                        | Outposts用バケットのバージョニング設定を取得する                   |
| GetDataAccess                              | Access Grantsを使用して一時的な認証情報を取得する                  |
| GetJobTagging                              | バッチオペレーションジョブのタグを取得する                         |
| GetMultiRegionAccessPoint                  | マルチリージョンアクセスポイントの詳細を取得する                   |
| GetMultiRegionAccessPointPolicy            | マルチリージョンアクセスポイントポリシーを取得する                 |
| GetMultiRegionAccessPointPolicyStatus      | マルチリージョンアクセスポイントポリシーのパブリック状態を取得する |
| GetMultiRegionAccessPointRoutes            | マルチリージョンアクセスポイントのルーティング設定を取得する       |
| GetPublicAccessBlock                       | アカウントレベルのパブリックアクセスブロック設定を取得する         |
| GetStorageLensConfiguration                | Storage Lens設定を取得する                                         |
| GetStorageLensConfigurationTagging         | Storage Lens設定のタグを取得する                                   |
| GetStorageLensGroup                        | Storage Lensグループの詳細を取得する                               |
| ListAccessGrants                           | アクセス許可一覧を取得する                                         |
| ListAccessGrantsInstances                  | Access Grantsインスタンス一覧を取得する                            |
| ListAccessGrantsLocations                  | Access Grantsロケーション一覧を取得する                            |
| ListAccessPoints                           | アクセスポイント一覧を取得する                                     |
| ListAccessPointsForDirectoryBuckets        | ディレクトリバケット用アクセスポイント一覧を取得する               |
| ListAccessPointsForObjectLambda            | Object Lambda用アクセスポイント一覧を取得する                      |
| ListCallerAccessGrants                     | 呼び出し元のアクセス許可一覧を取得する                             |
| ListJobs                                   | バッチオペレーションジョブ一覧を取得する                           |
| ListMultiRegionAccessPoints                | マルチリージョンアクセスポイント一覧を取得する                     |
| ListRegionalBuckets                        | Outposts用リージョナルバケット一覧を取得する                       |
| ListStorageLensConfigurations              | Storage Lens設定一覧を取得する                                     |
| ListStorageLensGroups                      | Storage Lensグループ一覧を取得する                                 |
| ListTagsForResource                        | リソースのタグ一覧を取得する                                       |
| PutAccessGrantsInstanceResourcePolicy      | Access Grantsインスタンスのリソースポリシーを設定する              |
| PutAccessPointConfigurationForObjectLambda | Object Lambda用アクセスポイント設定を設定する                      |
| PutAccessPointPolicy                       | アクセスポイントポリシーを設定する                                 |
| PutAccessPointPolicyForObjectLambda        | Object Lambda用アクセスポイントポリシーを設定する                  |
| PutAccessPointScope                        | アクセスポイントスコープを設定する                                 |
| PutBucketLifecycleConfiguration            | Outposts用バケットのライフサイクル設定を設定する                   |
| PutBucketPolicy                            | Outposts用バケットポリシーを設定する                               |
| PutBucketReplication                       | Outposts用バケットのレプリケーション設定を設定する                 |
| PutBucketTagging                           | Outposts用バケットタグを設定する                                   |
| PutBucketVersioning                        | Outposts用バケットのバージョニング設定を設定する                   |
| PutJobTagging                              | バッチオペレーションジョブのタグを設定する                         |
| PutMultiRegionAccessPointPolicy            | マルチリージョンアクセスポイントポリシーを設定する                 |
| PutPublicAccessBlock                       | アカウントレベルのパブリックアクセスブロック設定を設定する         |
| PutStorageLensConfiguration                | Storage Lens設定を設定する                                         |
| PutStorageLensConfigurationTagging         | Storage Lens設定のタグを設定する                                   |
| SubmitMultiRegionAccessPointRoutes         | マルチリージョンアクセスポイントのルーティング設定を送信する       |
| TagResource                                | リソースにタグを付ける                                             |
| UntagResource                              | リソースからタグを削除する                                         |
| UpdateAccessGrantsLocation                 | Access Grantsロケーションを更新する                                |
| UpdateJobPriority                          | バッチオペレーションジョブの優先度を更新する                       |
| UpdateJobStatus                            | バッチオペレーションジョブのステータスを更新する                   |
| UpdateStorageLensGroup                     | Storage Lensグループを更新する                                     |

## CloudWatch メトリクス | デフォルトで取得

### ストレージメトリクス

S3バケットのストレージ使用量に関する日次メトリクスです。

| メトリクス名      | 内容                       |
| ----------------- | -------------------------- |
| `BucketSizeBytes` | バケット全体の合計サイズ   |
| `NumberOfObjects` | バケット内のオブジェクト数 |

---

# 【追加分】

**論点：対応すべき事項**
**オブジェクト操作による情報流出を防ぐため、S3データイベントをCloudTrailで取得すべきと考える。また証跡（いつ誰がどのバケットのどのオブジェクトを操作したか）を残すことができる。**

## 1. S3データイベント（CloudTrail）

デフォルトでは無効。オブジェクトレベルの操作を監視するには明示的な有効化が必要。

| アクション                  | 説明                           |
| --------------------------- | ------------------------------ |
| GetObject                   | オブジェクトの読み取り         |
| PutObject                   | オブジェクトのアップロード     |
| DeleteObject                | オブジェクトの削除             |
| CopyObject                  | オブジェクトのコピー           |
| CompleteMultipartUpload     | マルチパートアップロードの完了 |
| GetObjectAcl / PutObjectAcl | オブジェクトACLの取得/設定     |

## 2. S3イベント通知

AWS S3のデータ操作発生時にリアルタイムで通知を送信。以下の送信先に対応。

**対応イベントタイプ**

| イベントタイプ            | 説明                         |
| ------------------------- | ---------------------------- |
| s3:ObjectCreated:\*       | オブジェクト作成時           |
| s3:ObjectRemoved:\*       | オブジェクト削除時           |
| s3:ObjectRestore:\*       | Glacierからの復元時          |
| s3:Replication:\*         | レプリケーション関連         |
| s3:LifecycleExpiration:\* | ライフサイクルによる有効期限 |

---

- 参考ドキュメント：
  - [S3データイベント](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/cloudtrail-logging-s3-info.html)
  - [サーバーアクセスログ](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/ServerLogs.html)
  - [管理イベント](https://docs.aws.amazon.com/AmazonS3/latest/API/API_Operations.html)
    - [CloudTrail イベント](https://docs.aws.amazon.com/ja_jp/AmazonS3/latest/userguide/cloudtrail-logging-s3-info.html)

---

## 比較表

監査の要件ができればサーバーアクセスログでもOK

| 項目           | サーバーアクセスログ           | データイベント（CloudTrail）          |
| -------------- | ------------------------------ | ------------------------------------- |
| **目的**       | アクセス分析・トラブルシュート | セキュリティ監査・コンプライアンス    |
| **出力形式**   | スペース区切りテキスト         | JSON                                  |
| **配信遅延**   | 数時間かかることも             | 通常5〜15分程度                       |
| **料金**       | 無料（保存料金のみ）           | 有料（イベント数課金）                |
| **認証情報**   | 基本的な情報のみ               | 詳細（IAMロール、MFA等）              |
| **エラー詳細** | HTTPステータスコード           | エラーコード・メッセージ              |
| **統合性**     | S3単体                         | CloudWatch、Athena、他AWSサービス連携 |

## 使い分け

**サーバーアクセスログ向き**

- コスト重視
- 帯域やリクエスト数の分析
- 簡易的なアクセス確認

**データイベント向き**

- セキュリティ監査
- コンプライアンス要件（誰がいつ何をしたか）
- リアルタイムに近い監視
- 他AWSサービスとの連携

## 結論

厳密な監査が必要なら**データイベント**、コストを抑えた簡易ログなら**サーバーアクセスログ**という使い分けが一般的です。両方併用するケースもあります。

<!-- ## 4. CloudWatchリクエストメトリクス

デフォルトでは無効。バケットごとに有効化が必要。

| メトリクス          | 説明                         |
| ------------------- | ---------------------------- |
| AllRequests         | リクエスト総数               |
| GetRequests         | GETリクエスト数              |
| PutRequests         | PUTリクエスト数              |
| DeleteRequests      | DELETEリクエスト数           |
| 4xxErrors           | 4xxエラー数                  |
| 5xxErrors           | 5xxエラー数                  |
| FirstByteLatency    | 最初のバイトまでのレイテンシ |
| TotalRequestLatency | リクエスト全体のレイテンシ   |
| BytesDownloaded     | ダウンロードバイト数         |
| BytesUploaded       | アップロードバイト数         | -->

<!-- ## 2. S3サーバーアクセスログ（不要）

HTTPリクエストレベルの詳細ログ。

| フィールド  | 説明                         |
| ----------- | ---------------------------- |
| Remote IP   | リクエスト元のIPアドレス     |
| Request-URI | リクエストされたリソースパス |
| HTTP status | HTTPレスポンスステータス     |
| Bytes Sent  | 送信バイト数                 |
| Total Time  | リクエスト処理時間           |
| Referrer    | リファラー情報               |
| User-Agent  | クライアント情報             | -->
