# 監査証跡の全体設計と現状整理

## CTO説明資料

---

## 1. 大前提：なぜ監査証跡が必要か

### 監査証跡の本質

**「後から検証可能な状態を作ること」**

| 観点             | 目的                                                |
| ---------------- | --------------------------------------------------- |
| セキュリティ     | 不正行為の検知・抑止、インシデント発生時の原因究明  |
| コンプライアンス | 法令・認証基準への準拠証明（個人情報保護法、ISO等） |
| 説明責任         | 「誰が・いつ・何をしたか」を証明できる状態の維持    |
| 運用             | トラブルシューティング、変更管理の追跡              |

### 脅威カテゴリ（参照用）

| ID  | カテゴリ           | 概要                                 |
| --- | ------------------ | ------------------------------------ |
| Ⅰ   | アクセス・利用制限 | 認証認可、権限設計                   |
| Ⅱ   | ネットワーク対策   | 通信暗号化、IP制御                   |
| Ⅲ   | Web対策            | OWASP等の攻撃対策                    |
| Ⅳ   | データの秘匿       | DB暗号化、機微情報管理               |
| Ⅴ   | 不正追跡・監視     | 権限設計、監査ログ                   |
| Ⅵ   | LLM                | 取り扱いデータ定義、ディスクレーマー |

---

## 2. 監査証跡の全量マップ（全コンポーネント）

### 凡例

- **アクセス経路**: Web＝Webサービス経由（Cognito認証）、AWS＝AWSリソース直接（IAM認証）、External＝外部連携
- **脅威カテゴリ**: Ⅰ〜Ⅵは上記参照
- **通知**: ◎＝必須、○＝推奨、△＝任意、-＝不要
- **現状**: ✅ 取得中、⚠️ 一部/要確認、❌ 未対応、- 対象外

### 注釈

- **※1** Cognito：CloudTrail管理イベントで認証APIは取得中。詳細なログイン成功/失敗ログはCognito高度なセキュリティ機能の有効化が必要
- **※2** S3：CloudTrail管理イベントでバケット操作は取得中。オブジェクトレベル（GetObject/PutObject等）はデータイベントの有効化が必要
- **※3** DynamoDB：CloudTrail管理イベントでテーブル操作は取得中。アイテムレベル（GetItem/PutItem等）はデータイベントの有効化が必要

### 【認証・認可】

| コンポーネント | アクセス経路 | 取得ログ          | なぜ必要か                       | 現状          | 脅威カテゴリ | 取得手段                 | 通知 |
| -------------- | ------------ | ----------------- | -------------------------------- | ------------- | ------------ | ------------------------ | ---- |
| HENNGE ONE     | Web          | SSO認証ログ       | 入口での不正アクセス検知         | ❌ 未対応     | Ⅰ            | HENNGE管理画面           | ◎    |
| Cognito        | Web          | ログイン成功/失敗 | なりすまし、不正ログイン検知     | ⚠️ 一部（※1） | Ⅰ            | CloudTrail + Cognitoログ | ◎    |
| IAM            | AWS          | 権限変更、認証    | 特権アカウント濫用、不正権限付与 | ✅ 取得中     | Ⅰ,Ⅴ          | CloudTrail               | ◎    |

### 【ネットワーク・エッジ】

| コンポーネント | アクセス経路 | 取得ログ      | なぜ必要か                       | 現状      | 脅威カテゴリ | 取得手段           | 通知 |
| -------------- | ------------ | ------------- | -------------------------------- | --------- | ------------ | ------------------ | ---- |
| Route53        | Web/AWS      | DNSクエリログ | 不正なDNS操作の検知              | ❌ 未対応 | Ⅱ            | Route53 Query Logs | △    |
| CloudFront     | Web          | アクセスログ  | 不正アクセス元の特定             | ❌ 未対応 | Ⅱ,Ⅲ          | CloudFrontログ     | △    |
| WAF（Front）   | Web          | ブロック/許可 | SQLi、XSS等の攻撃検知            | ❌ 未対応 | Ⅲ            | WAF Logs           | ◎    |
| Internet GW    | Web          | -             | （VPC Flow Logsで取得）          | -         | Ⅱ            | -                  | -    |
| NAT GW         | AWS          | -             | （VPC Flow Logsで取得）          | -         | Ⅱ            | -                  | -    |
| VPC            | Web/AWS      | 通信ログ      | 不正通信、データ持ち出し経路特定 | ❌ 未対応 | Ⅱ            | VPC Flow Logs      | △    |

### 【アプリケーション層】

| コンポーネント       | アクセス経路 | 取得ログ                 | なぜ必要か                     | 現状      | 脅威カテゴリ | 取得手段        | 通知 |
| -------------------- | ------------ | ------------------------ | ------------------------------ | --------- | ------------ | --------------- | ---- |
| ALB                  | Web          | アクセスログ             | リクエスト元・先の追跡         | ❌ 未対応 | Ⅱ,Ⅲ          | ALBアクセスログ | △    |
| ECS/Fargate          | Web/AWS      | コンテナログ             | アプリエラー、不正操作の追跡   | ❌ 未対応 | Ⅴ            | CloudWatch Logs | ○    |
| Next.js（Webアプリ） | Web          | 認証ログ                 | ログイン成功/失敗の追跡        | ❌ 未対応 | Ⅰ,Ⅴ          | アプリログ      | ◎    |
|                      | Web          | 参照ログ                 | 「誰が何を見たか」の追跡       | ❌ 未対応 | Ⅳ,Ⅴ          | アプリログ      | △    |
|                      | Web          | 変更ログ（Before/After） | データ改ざん時の原因特定・復旧 | ❌ 未対応 | Ⅳ,Ⅴ          | アプリログ      | ○    |
|                      | Web          | 出力ログ                 | データ持ち出しの検知           | ❌ 未対応 | Ⅳ,Ⅴ          | アプリログ      | ◎    |
| ECR                  | AWS          | イメージPush/Pull        | 改ざんコンテナのデプロイ検知   | ✅ 取得中 | Ⅴ            | CloudTrail      | ◎    |
| Systems Manager      | AWS          | パラメータアクセス       | 環境変数・設定値の不正取得検知 | ✅ 取得中 | Ⅳ,Ⅴ          | CloudTrail      | ◎    |

### 【API・バックエンド】

| コンポーネント    | アクセス経路 | 取得ログ         | なぜ必要か              | 現状      | 脅威カテゴリ | 取得手段        | 通知 |
| ----------------- | ------------ | ---------------- | ----------------------- | --------- | ------------ | --------------- | ---- |
| WAF（API）        | Web          | ブロック/許可    | API経由の攻撃検知       | ❌ 未対応 | Ⅲ            | WAF Logs        | ◎    |
| API Gateway       | Web          | アクセスログ     | API呼び出しの追跡       | ❌ 未対応 | Ⅴ            | CloudWatch Logs | ○    |
| Lambda（API処理） | Web/AWS      | 実行ログ         | 処理内容・エラーの追跡  | ❌ 未対応 | Ⅴ            | CloudWatch Logs | ○    |
| Lambda（Bedrock） | AWS          | LLM呼び出し      | 機微データのLLM入力監視 | ❌ 未対応 | Ⅳ,Ⅵ          | CloudWatch Logs | ○    |
| Lambda（Tavily）  | AWS          | 外部API呼び出し  | 外部への情報送信追跡    | ❌ 未対応 | Ⅳ,Ⅴ          | CloudWatch Logs | ○    |
| Lambda（ETL）     | AWS          | ETL処理ログ      | データ加工処理の追跡    | ❌ 未対応 | Ⅳ,Ⅴ          | CloudWatch Logs | ○    |
| SQS               | AWS          | メッセージ送受信 | 非同期処理の追跡        | ✅ 取得中 | Ⅴ            | CloudTrail      | △    |
| EventBridge       | AWS          | イベント発火     | 自動処理トリガーの追跡  | ✅ 取得中 | Ⅴ            | CloudTrail      | △    |

### 【データストア】

| コンポーネント  | アクセス経路 | 取得ログ             | なぜ必要か                           | 現状          | 脅威カテゴリ | 取得手段            | 通知 |
| --------------- | ------------ | -------------------- | ------------------------------------ | ------------- | ------------ | ------------------- | ---- |
| S3（出力資料）  | Web/AWS      | オブジェクト操作     | ブリーフィング資料への不正アクセス   | ⚠️ 一部（※2） | Ⅳ,Ⅴ          | CloudTrail / S3ログ | ◎    |
| S3（SFデータ）  | AWS          | オブジェクト操作     | SF生データへの不正アクセス           | ⚠️ 一部（※2） | Ⅳ,Ⅴ          | CloudTrail / S3ログ | ◎    |
| RDS             | AWS          | DB接続・クエリ       | 加工データへの不正アクセス、大量抽出 | ❌ 未対応     | Ⅳ,Ⅴ          | RDS監査ログ         | ◎    |
| DynamoDB        | Web/AWS      | テーブル操作         | データ改ざん・不正取得               | ⚠️ 一部（※3） | Ⅳ,Ⅴ          | CloudTrail          | ○    |
| Secrets Manager | AWS          | シークレットアクセス | 認証情報の不正取得                   | ✅ 取得中     | Ⅰ,Ⅳ          | CloudTrail          | ◎    |

### 【AI・外部連携】

| コンポーネント      | アクセス経路 | 取得ログ       | なぜ必要か                    | 現状      | 脅威カテゴリ | 取得手段        | 通知 |
| ------------------- | ------------ | -------------- | ----------------------------- | --------- | ------------ | --------------- | ---- |
| Bedrock             | AWS          | モデル呼び出し | LLMへの入出力監視、コスト監視 | ❌ 未対応 | Ⅳ,Ⅵ          | CloudWatch Logs | ○    |
| Tavily Search       | External     | API呼び出し    | 外部検索への情報送信追跡      | ❌ 未対応 | Ⅳ,Ⅵ          | アプリログ      | ○    |
| DataHub（Gecogeco） | External     | データ連携     | SF→S3のデータ取り込み追跡     | ❌ 未対応 | Ⅳ,Ⅴ          | 連携ログ        | ○    |

### 【セキュリティ監視】

| コンポーネント | アクセス経路 | 取得ログ             | なぜ必要か                 | 現状      | 脅威カテゴリ | 取得手段     | 通知 |
| -------------- | ------------ | -------------------- | -------------------------- | --------- | ------------ | ------------ | ---- |
| CloudTrail     | AWS          | API呼び出し全般      | 全AWS操作の追跡基盤        | ✅ 取得中 | Ⅴ            | CloudTrail   | -    |
| CloudWatch     | AWS          | メトリクス・ログ     | リアルタイム監視基盤       | ⚠️ 要確認 | Ⅴ            | CloudWatch   | -    |
| AWS Config     | AWS          | 構成変更             | 設定変更の追跡             | ❌ 未対応 | Ⅴ            | AWS Config   | ◎    |
| GuardDuty      | AWS          | 脅威検知             | 攻撃の早期発見             | ❌ 未対応 | Ⅴ            | GuardDuty    | ◎    |
| Inspector      | AWS          | 脆弱性スキャン       | 既知脆弱性の検知           | ❌ 未対応 | Ⅲ,Ⅴ          | Inspector    | ◎    |
| Security Hub   | AWS          | コンプライアンス違反 | ベストプラクティス逸脱検知 | ❌ 未対応 | Ⅴ            | Security Hub | ◎    |

---

## 3. 環境別の方針

| 環境       | マスキング | 監査証跡           | 通知             |
| ---------- | ---------- | ------------------ | ---------------- |
| 開発(dev)  | ✅ 実施    | 任意（有効化推奨） | 任意             |
| 試験(dev2) | ❌ なし    | **必須**           | 定常外操作は通知 |
| 本番(prd)  | ❌ なし    | **必須**           | 定常外操作は通知 |

---

## 4. 監査証跡の記録項目（MUST/WANT）

| #   | 項目             | MUST                           | WANT                          |
| --- | ---------------- | ------------------------------ | ----------------------------- |
| 1   | **操作日時**     | 正確な時刻（タイムゾーン明示） | UTC統一、表示時にローカル変換 |
| 2   | **操作ユーザー** | ユーザーID、認証情報           | ロール・権限も記録            |
| 3   | **操作内容**     | 何をしたか（CRUD、LOGIN等）    | API呼び出し・UI操作の種類     |
| 4   | **操作対象**     | 対象データ・サービス           | 変更前後の値（Before/After）  |
| 5   | **操作元情報**   | IPアドレス、端末情報           | User-Agent、アクセス方法      |
| 6   | **結果**         | 成功/失敗、エラーコード        | 通知内容・通知本文            |

---

## 5. 進め方

| #   | ステップ               | 内容                                       |
| --- | ---------------------- | ------------------------------------------ |
| 1   | **要件確認**           | JMCの要件 + 一般的なセキュリティ要件の整理 |
| 2   | **コンポーネント全量** | 本資料で完了 ✅                            |
| 3   | **取得項目の特定**     | 各コンポーネントで何を取るべきかの決定     |
| 4   | **実装方法の確定**     | どうやって取れるかの技術検証・設計         |
| 5   | **通知設定**           | 定常外操作のSlack通知設定                  |

---

## 6. 次のアクション

1. **現状調査**: 各コンポーネントの取得状況・通知設定を確認
2. **ギャップ特定**: 現状と理想の差分を具体化
3. **優先順位付け**: 通知◎のものから優先対応
4. **実装計画**: 対応スケジュールの策定

承知しました。具体的な要求項目を記載した全体の表を出力します。

| ID  | カテゴリ           | 具体的なリスク             | 対策                                                                                       | 対策用コンポーネント                        | 対策する必要があるコンポーネント               | 関連要求                                                                                                                                                                                                                                                         |
| :-: | :----------------- | :------------------------- | :----------------------------------------------------------------------------------------- | :------------------------------------------ | :--------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
|  Ⅰ  | アクセス・利用制限 | 不正ログイン               | 多要素認証(MFA)の導入、アカウントロックアウト、Cognito/AWSユーザー発行管理、HENNGE ONE連携 | IAM、Cognito、HENNGE ONE                    | API Gateway、ALB、ECS/Fargate                  | ・Webサービス経由：Cognitoユーザーを発行<br>・AWSリソース直接：AWSユーザーを発行<br>・E,F：HENNGE ONE・AWSアカウントを発行しない                                                                                                                                 |
|     |                    | 権限昇格                   | 最小権限の原則(PoLP)、RBAC/ABACによる権限管理、役割定義(A〜G)に基づく環境別アクセス制御    | IAM、Cognito                                | Lambda、ECS/Fargate、RDS、S3、DynamoDB         | ・役割定義（A〜G）に基づくデータ種類別アクセス権限<br>・環境別（dev/dev2/prd）権限マトリクス<br>・Fは認可制御でアクセスを弾く                                                                                                                                    |
|     |                    | パスワードリスト攻撃       | 強固なパスワードポリシー、ログイン試行制限、短時間での大量認証失敗検知・通知               | WAF、Cognito、CloudWatch Alarms             | API Gateway、CloudFront                        | ・No.29: 短時間での大量の認証失敗を検知・通知                                                                                                                                                                                                                    |
|     |                    | 入口からの不正アクセス     | IP制限（許可外IPはアクセス不可）、VPN必須化、ゼロトラストアーキテクチャ                    | WAF、VPC、Security Group                    | ALB、API Gateway、VPC Endpoint                 | ・G（ネットワーク外）：許可外のIPアドレスはアクセスできない                                                                                                                                                                                                      |
|  Ⅱ  | ネットワーク対策   | 通信傍受・盗聴             | TLS1.3による通信暗号化、証明書ピンニング                                                   | ACM※、CloudFront                            | ALB、API Gateway、RDS                          | -                                                                                                                                                                                                                                                                |
|     |                    | 中間者攻撃（MITM）         | HSTS設定、証明書検証の厳格化、VPN利用                                                      | CloudFront、ACM※                            | ALB、ECS/Fargate                               | -                                                                                                                                                                                                                                                                |
|     |                    | 不正なネットワーク侵入     | ファイアウォール/WAF、IDS/IPS、ネットワークセグメンテーション                              | WAF、VPC、GuardDuty                         | Public/Private subnet、NAT Gateway             | -                                                                                                                                                                                                                                                                |
|  Ⅲ  | Web対策            | SQLインジェクション        | パラメータ化クエリ、入力バリデーション、WAF                                                | WAF                                         | RDS Lambda、RDS、RDS Proxy                     | -                                                                                                                                                                                                                                                                |
|     |                    | XSS                        | 出力エスケープ、CSP、HttpOnly Cookie                                                       | WAF、CloudFront                             | ECS/Fargate（Next.js）                         | -                                                                                                                                                                                                                                                                |
|     |                    | CSRF                       | CSRFトークン、SameSite Cookie属性                                                          | ECS/Fargate（実装）                         | ECS/Fargate（Next.js）                         | -                                                                                                                                                                                                                                                                |
|     |                    | ディレクトリトラバーサル   | パス正規化、入力値検証                                                                     | WAF                                         | S3、ECS/Fargate                                | -                                                                                                                                                                                                                                                                |
|  Ⅳ  | データの秘匿       | DB不正アクセス             | DBファイアウォール、接続元IP制限、強固な認証                                               | VPC、Security Group、RDS Proxy              | RDS、DynamoDB、OpenSearch                      | -                                                                                                                                                                                                                                                                |
|     |                    | 機密情報の平文保存         | 保存時暗号化、カラムレベル暗号化、鍵管理、ログの論理暗号化                                 | KMS※、Systems Manager                       | S3、RDS、DynamoDB、OpenSearch、CloudWatch Logs | ・No.50: 業務データ、個人情報のログは平文で保存しない。論理暗号化を行う<br>・対象：リクエストボディの業務データ、レスポンスボディの個人情報、監査ログの機微情報                                                                                                  |
|     |                    | 情報漏洩                   | データマスキング、DLP導入、アクセス権限の厳格化                                            | S3（バケットポリシー）、IAM                 | S3、RDS、DynamoDB                              | ・dev環境：取り扱いデータはマスキングを行う<br>・dev2/prd環境：マスキングを行わない                                                                                                                                                                              |
|  Ⅴ  | 不正追跡・監視     | 内部不正                   | 職務分掌、特権アクセス管理(PAM)、操作ログ取得、監査ログの5W1H記録                          | CloudTrail、IAM、CloudWatch Logs            | 全コンポーネント                               | ・監査証跡要件：操作日時(UTC)、操作ユーザー(ID/ロール)、操作内容(CRUD/LOGIN等)、操作対象(データ/サービス)、操作元(IP/端末/User-Agent)、結果(成功/失敗/エラーコード)<br>・No.56: CloudTrailでAWSリソースへの操作ログを保存、CloudWatch Logs Insights/Athenaで分析 |
|     |                    | 証跡改ざん                 | ログの改ざん防止、別システムへのログ転送、アクセスログ（リクエスト/レスポンス）の保管      | CloudTrail、S3（ログ保管）、CloudWatch Logs | CloudWatch、CloudTrail、API Gateway、ALB       | ・No.49: HTTPリクエスト（メソッド、パス、ヘッダー、ボディ）とレスポンス（Status Code、ボディ）、処理時間を保存<br>・対象：CloudFront、WAF、ALB、API Gateway、ECS、Lambda                                                                                         |
|     |                    | 不正操作の検知遅延         | SIEM統合監視、リアルタイムアラート、異常検知、異常アクセス失敗の検知・通知                 | CloudWatch、Security Hub、CloudWatch Alarms | 全コンポーネント                               | ・No.29: 通常操作では発生し得ないアクセスの失敗を記録・通知<br>・定常操作：監査証跡を取得、通知設定なし<br>・定常外操作：監査証跡を取得、通知を設定                                                                                                              |
|     |                    | 攻撃の検知遅延             | IDS/IPS、脅威インテリジェンス活用、異常アクセスパターンの検知・通知                        | GuardDuty、Security Hub、Inspector          | VPC、ECS/Fargate、Lambda                       | ・No.29検知対象：存在しないエンドポイントへのアクセス試行、権限のないリソースへのアクセス試行（403エラー）、WAFでブロックされたリクエスト                                                                                                                        |
|     |                    | インシデント対応の遅れ     | SOC運用、エスカレーションフロー整備、Slack通知連携                                         | CloudWatch（アラーム）、EventBridge、SNS    | 全コンポーネント                               | ・通知先：bs-notification-dev/stg/prd（Slack）<br>・原則として通知等での「自動化」を推奨<br>・月次確認や通知確認などは人手でOK                                                                                                                                   |
|  Ⅵ  | LLM取り扱い        | プロンプトインジェクション | 入力サニタイズ、システムプロンプト保護、ガードレール                                       | Bedrock Guardrails※                         | Bedrock、Tavily&Bedrock Lambda                 | -                                                                                                                                                                                                                                                                |
|     |                    | 機密情報の意図しない出力   | 出力フィルタリング、PII検出・マスキング                                                    | Bedrock Guardrails※、Lambda（実装）         | Bedrock、Tavily&Bedrock Lambda                 | -                                                                                                                                                                                                                                                                |
|     |                    | ハルシネーション           | RAG/グラウンディング、免責事項表示                                                         | OpenSearch、RDS（参照データ）               | Bedrock、Tavily&Bedrock Lambda                 | -                                                                                                                                                                                                                                                                |

**凡例**

- **※印**: 添付のコンポーネント一覧に含まれていないが、対策に必要と考えられるサービス（ACM、KMS、Bedrock Guardrails）
- **-**: 今回の要求ドキュメントでは直接言及されていない項目
