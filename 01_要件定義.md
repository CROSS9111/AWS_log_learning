# 面談前ブリーフィングシステム ログ要件定義書

## 改訂履歴

| 版数 | 日付       | 改訂内容 | 作成者 |
| :--: | :--------- | :------- | :----- |
| 1.0  | 2025/01/20 | 初版作成 | -      |

---

## 1. 概要

### 1.1 目的

本書は、面談前ブリーフィングシステムにおけるアプリ管理、データ管理の安全性を確保するため、ログに関する要件を定義する。

### 1.2 対象システム

面談前ブリーフィングシステム（AWS Cloud上に構築）

### 1.3 スコープ

本要件定義書では以下を対象とする。

- アクセス制御に関する要件
- 監査証跡に関する要件
- 通知に関する要件
- セキュリティに関する要件

---

## 2. アクセス制御要件

### 2.1 役割定義

| 記号 | 役割                                 | 所属     |
| :--: | :----------------------------------- | :------- |
|  A   | システム開発ベンダー                 | Tech0    |
|  B   | インフラベンダー                     | gecogeco |
|  C   | IT推進部                             | JMAC     |
|  D   | 営業開発室                           | JMAC     |
|  E   | 営業担当                             | JMAC     |
|  F   | SFに閲覧制限のある出向者など         | JMAC     |
|  G   | ネットワーク外（部外者 or 私用端末） | -        |

### 2.2 データ種類

| 記号 | データ種類                            |
| :--: | :------------------------------------ |
|  ①   | S3 出力資料（ブリーフィング出力資料） |
|  ②   | RDS 加工データ                        |
|  ③   | S3 SFデータ（Salesforceデータ）       |

### 2.3 開発環境（dev）

| 役割                    | ① S3出力資料 | ② RDS加工データ | ③ S3 SFデータ |
| :---------------------- | :----------: | :-------------: | :-----------: |
| A. システム開発ベンダー |   ✅ 許可    |     ✅ 許可     |    ✅ 許可    |
| B. インフラベンダー     |   ✅ 許可    |     ✅ 許可     |    ✅ 許可    |
| C. IT推進部             |   ✅ 許可    |     ✅ 許可     |    ✅ 許可    |
| D. 営業開発室           |   ✅ 許可    |     ✅ 許可     |    ✅ 許可    |
| E. 営業担当             |   ❌ 不可    |     ❌ 不可     |    ❌ 不可    |
| F. SF閲覧制限者         |   ❌ 不可    |     ❌ 不可     |    ❌ 不可    |
| G. ネットワーク外       |   ❌ 不可    |     ❌ 不可     |    ❌ 不可    |

**ケア方針：**

- 取り扱いデータはマスキングを行う
- 明示的に監査証跡・通知設定は義務化しない
- 試験環境・本番環境への通知等の確認目的で、監査証跡の取得や通知設定を有効化しても良い

**アクセス制御：**

- E, F：HENNGE ONE・AWSアカウントを発行しない
- G：許可外のIPアドレスはアクセスできない

### 2.4 試験環境（dev2）

| 役割                    | ① S3出力資料 | ② RDS加工データ | ③ S3 SFデータ |
| :---------------------- | :----------: | :-------------: | :-----------: |
| A. システム開発ベンダー |   ✅ 許可    |     ✅ 許可     |    ✅ 許可    |
| B. インフラベンダー     |   ✅ 許可    |     ✅ 許可     |    ✅ 許可    |
| C. IT推進部             |   ✅ 許可    |     ✅ 許可     |    ✅ 許可    |
| D. 営業開発室           |   ✅ 許可    |     ❌ 不可     |    ❌ 不可    |
| E. 営業担当             |   ❌ 不可    |     ❌ 不可     |    ❌ 不可    |
| F. SF閲覧制限者         |   ❌ 不可    |     ❌ 不可     |    ❌ 不可    |
| G. ネットワーク外       |   ❌ 不可    |     ❌ 不可     |    ❌ 不可    |

**ケア方針：**

- 取り扱いデータはマスキングを行わない

**① S3出力資料へのアクセス：**

- 【Webサービス経由】A, C, DにCognitoユーザーを発行。監査証跡を取得。定常操作のため通知設定なし
- 【AWSリソース直接】A, B, CにAWSユーザーを発行。監査証跡を取得。定常操作ではないので通知を設定

**② RDS加工データへのアクセス：**

- 【Webサービス経由】直接アクセスさせない
- 【AWSリソース直接】A, B, CにAWSユーザーを発行。監査証跡を取得。定常操作ではないので通知を設定

**③ S3 SFデータへのアクセス：**

- 【Webサービス経由】直接アクセスさせない
- 【AWSリソース直接】A, B, CにAWSユーザーを発行。監査証跡を取得。定常操作ではないので通知を設定

**アクセス制御：**

- D：AWSアカウントを発行しない
- E, F：HENNGE ONE・AWSアカウントを発行しない
- G：許可外のIPアドレスはアクセスできない

### 2.5 本番環境（prd）

| 役割                    | ① S3出力資料 | ② RDS加工データ | ③ S3 SFデータ |
| :---------------------- | :----------: | :-------------: | :-----------: |
| A. システム開発ベンダー |   ❌ 不可    |     ❌ 不可     |    ❌ 不可    |
| B. インフラベンダー     |   ✅ 許可    |     ✅ 許可     |    ✅ 許可    |
| C. IT推進部             |   ✅ 許可    |     ✅ 許可     |    ✅ 許可    |
| D. 営業開発室           |   ✅ 許可    |     ❌ 不可     |    ❌ 不可    |
| E. 営業担当             |   ✅ 許可    |     ❌ 不可     |    ❌ 不可    |
| F. SF閲覧制限者         |   ❌ 不可    |     ❌ 不可     |    ❌ 不可    |
| G. ネットワーク外       |   ❌ 不可    |     ❌ 不可     |    ❌ 不可    |

**ケア方針：**

- 取り扱いデータはマスキングを行わない

**① S3出力資料へのアクセス：**

- 【Webサービス経由】C, D, EにCognitoユーザーを発行。監査証跡を取得。定常操作のため通知設定なし。**Fは認可制御でアクセスを弾く**
- 【AWSリソース直接】B, CにAWSユーザーを発行。監査証跡を取得。定常操作ではないので通知を設定

**② RDS加工データへのアクセス：**

- 【Webサービス経由】直接アクセスさせない
- 【AWSリソース直接】B, CにAWSユーザーを発行。監査証跡を取得。定常操作ではないので通知を設定

**③ S3 SFデータへのアクセス：**

- 【Webサービス経由】直接アクセスさせない
- 【AWSリソース直接】B, CにAWSユーザーを発行。監査証跡を取得。定常操作ではないので通知を設定

**アクセス制御：**

- A, D：AWSアカウントを発行しない
- F：アカウントを発行しない
- G：許可外のIPアドレスはアクセスできない

---

## 3. 監査証跡要件

### 3.1 操作日時（Timestamp）

- **【MUST】** すべてのイベントに正確な時刻を記録（タイムゾーンも明示）
- **【WANT】** UTCで統一し、表示時にローカル変換

### 3.2 操作ユーザー（User Identity）

- **【MUST】** ユーザーID、認証情報（SSOやLDAP連携の場合はそのID）
- **【WANT】** 必要に応じてロールや権限も記録

### 3.3 操作内容（Action）

- **【MUST】** 何をしたか（例：CREATE、READ、UPDATE、DELETE、LOGIN、LOGOUT、DOWNLOAD）
- **【WANT】** API呼び出しやUI操作の種類も明示

### 3.4 操作対象（Object）

- **【MUST】** 操作対象のデータ・サービス（例：Salesforce由来のデータ、マネージドサービス）
- **【WANT】** 変更前後の値（Before/After）を記録

### 3.5 操作元情報（Source）

- **【MUST】** IPアドレス、端末情報、アプリケーション名
- **【WANT】** WebならUser-Agent、AWSならアクセス方法

### 3.6 結果（Outcome）

- **【MUST】** 成功／失敗、エラーコード、例外メッセージ
- **【WANT】** 結果に基づく通知内容と通知本文

---

## 4. 通知要件

### 4.1 通知条件（Notification）

- **【MUST】** 定常時では想定しない操作を対象に通知する

### 4.2 通知内容

- **【MUST】** 監査証跡でも記している内容を通知に出力する

### 4.3 通知先

- **【MUST】** 所定のSlack通知先
  - bs-notification-dev
  - bs-notification-stg
  - bs-notification-prd

### 4.4 ポイント

- 環境 × 運用体制 → Dev、Stg、Prd、およびリソース側面を考慮
- 原則として通知等での「自動化」を推奨し、安易な運用保守工数への転嫁はしない
- 月次確認や通知確認などは人手でOK

---

## 5. セキュリティ要件

### 5.1 要件一覧

| No. | 要件内容                                                                                                                                                            | 種別       |
| :-: | :------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :--------- |
| 29  | 通常操作では発生し得ないアクセスの失敗については記録、通知を行う。                                                                                                  | 検知       |
| 49  | ユーザのアクション（HTTPリクエスト＋パス）とそれに対するレスポンス（HTTP Status Code + レスポンスボディ）を保存する。証跡を残す。証跡を閲覧、分析できるようにする。 | 予防, 検知 |
| 50  | 業務データ、個人情報のログは平文で保存しない。論理暗号化を行う。                                                                                                    | 予防       |
| 56  | AWS CloudTrail を利用して、AWSリソースへの操作ログを保存する。保存したログを閲覧、分析できるようにする。                                                            | 予防       |

### 5.2 No.29 異常アクセス検知の詳細

通常操作では発生し得ないアクセスの失敗について、以下を記録・通知する。

**検知対象：**

- 短時間での大量の認証失敗
- 存在しないエンドポイントへのアクセス試行
- 権限のないリソースへのアクセス試行（403エラー）
- WAFでブロックされたリクエスト

### 5.3 No.49 HTTPリクエスト/レスポンス証跡の詳細

ユーザのアクションとレスポンスを保存し、証跡として閲覧・分析できるようにする。

**記録対象：**

- HTTPリクエスト（メソッド、パス、ヘッダー、ボディ）
- HTTPレスポンス（Status Code、レスポンスボディ）
- 処理時間

**対象コンポーネント：**

- CloudFront
- WAF
- ALB
- API Gateway
- ECS（フロントエンド）
- Lambda（バックエンド）

### 5.4 No.50 ログ暗号化の詳細

業務データ、個人情報のログは平文で保存せず、論理暗号化を行う。

**対象：**

- リクエストボディに含まれる業務データ
- レスポンスボディに含まれる個人情報
- 監査ログに含まれる機微情報

### 5.5 No.56 CloudTrailの詳細

AWS CloudTrailを利用して、AWSリソースへの操作ログを保存する。

**対象：**

- すべてのAWSリソースへの操作
- マネジメントコンソール、CLI、SDKからのアクセス

**分析方法：**

- CloudWatch Logs Insights
- Amazon Athena

---

## 6. 参考：ケア支援のためのAWSサービス

| サービス        | 用途                                     |
| :-------------- | :--------------------------------------- |
| AWS Config      | リソース構成変更の履歴確認               |
| CloudTrail      | AWSリソースへの各種アクセスの追跡        |
| CloudWatch Logs | リアルタイムモニタリング                 |
| SNS             | 定常外操作時の通知                       |
| Security Hub    | コンプライアンス違反確認                 |
| GuardDuty       | 不審（不正の可能性がある）アクセスの検出 |

---

| やること                                  | 対応する要件 | 具体的な内容                                           |
| :---------------------------------------- | :----------: | :----------------------------------------------------- |
| **アクセス制御を実装する**                |     2章      | 環境×役割ごとのアクセス可否を制御                      |
| 　├ AWSアカウント管理                     |              | 役割に応じたIAMユーザー発行/未発行                     |
| 　├ Cognito認証                           |              | Webサービス経由のアクセス制御                          |
| 　├ HENNGE ONE連携                        |              | SSO認証によるアクセス制御                              |
| 　└ IPアドレス制限                        |              | ネットワーク外からのアクセス遮断                       |
| **CloudTrailでAWSリソース操作ログを残す** |  No.56, 2章  | 管理イベント + S3データイベント                        |
| **RDSの監査ログを有効化する**             |  No.56, 2章  | SQLクエリの証跡を残す                                  |
| **アプリ側のアクションをログに残す**      |    No.49     | HTTPリクエスト/レスポンスの証跡保存                    |
| 　├ リソース側の設定                      |              | API Gateway、ALB、CloudFrontのログ有効化               |
| 　└ アプリ側のコード実装                  |              | ECS（Next.js）、Lambdaでのログ出力                     |
| **ログは監査証跡要件に則る**              |     3章      | 操作日時、ユーザー、操作内容、対象、操作元、結果を記録 |
| **ログの暗号化**                          |    No.50     | 業務データ・個人情報を平文で保存しない                 |
| **異常検知・通知**                        |  No.29, 4章  | 異常アクセス失敗時の記録・Slack通知                    |
